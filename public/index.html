<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
 <title>CASW Inventory Tracker</title>
 <link rel="stylesheet" href="styles.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
 <style>
   /* Modal Styles */
   .modal-overlay {
     position: fixed;
     top: 0;
     left: 0;
     width: 100vw;
     height: 100vh;
     background: rgba(0, 0, 0, 0.85);
     display: flex;
     justify-content: center;
     align-items: center;
     z-index: 9999;
     opacity: 0;
     pointer-events: none;
     transition: opacity 0.3s ease;
   }


   .modal-overlay.show {
     opacity: 1;
     pointer-events: auto;
   }


   .modal-content {
     max-width: 90%;
     max-height: 90%;
     animation: scaleIn 0.3s ease;
   }


   .modal-content img {
     max-width: 100%;
     max-height: 100%;
     border-radius: 8px;
     box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
   }


   @keyframes scaleIn {
     from {
       transform: scale(0.95);
       opacity: 0;
     }
     to {
       transform: scale(1);
       opacity: 1;
     }
   }
 </style>
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>


<!-- Image Modal -->
<div id="imageModal" class="modal-overlay">
 <div class="modal-content">
   <img id="modalImage" src="" alt="Preview">
 </div>
</div>

<!-- Chart Modal -->
<div id="chartModal" class="modal-overlay">
  <div class="modal-content">
    <canvas id="summaryChart" width="500" height="300"></canvas>
  </div>
</div>



<!-- 🔓 Logout button -->
<button id="logoutBtn" style="display: none;" class="logout-btn">Logout</button>
<button id="chartBtn" style="display: none;" class="chart-btn">📊 Chart</button>
<img src="CASW.png" alt="C.A.S.W Logo" class="auth-logo" />


<!-- 🔐 Login Section -->
<div id="authSection" class="auth-container">
 <input type="email" id="email" placeholder="Email">
 <input type="password" id="password" placeholder="Password">
 <button id="loginBtn">Login</button>
</div>






<!-- ✅ Inventory Form -->
<form id="inventoryForm" style="display: none;">
 <div class="form-fields">
   <input type="text" id="serialNumber" placeholder="Serial Number" required>
   <input type="text" id="itemName" placeholder="Item Name" required>
   <input type="text" id="category" placeholder="Category" required>
   <select id="status">
     <option value="Available">Available</option>
     <option value="In Use">In Use</option>
   </select>
   <select id="site">
     <option value="PS 18">PS 18</option>
     <option value="Bronx River">Bronx River</option>
     <option value="Beacon">Beacon</option>
     <option value="Main Office">Main Office</option>
   </select>
   <input type="file" id="photo" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.svg,.heic,.tiff" capture="environment">
   <button type="submit">Add Item</button>
 </div>
</form>


<!-- ✅ Search + Export + Import -->
<div class="top-bar" style="display: none; justify-content: space-between; align-items: center; margin: 10px 0;">
 <input type="text" id="searchBox" placeholder="Search..." onkeyup="searchItems()">
 <div id="summary" style="font-weight: bold;"></div>

 <div>
   <input type="file" id="importFile" accept=".csv">
   <button id="importBtn" type="button">Import CSV</button>
   <button id="exportBtn" type="button">Export CSV</button>
 </div>
</div>


<!-- Inventory Table -->
<table id="inventoryTable" style="display: none;">
 <thead>
   <tr>
     <th onclick="sortTable(0)">Serial Number</th>
     <th onclick="sortTable(1)">Name</th>
     <th onclick="sortTable(2)">Category</th>
     <th onclick="sortTable(3)">Status</th>
     <th onclick="sortTable(4)">Site</th>
     <th onclick="sortTable(5)">Last Updated</th>
     <th>Photo</th>
     <th>Action</th>
   </tr>
 </thead>
 <tbody id="inventoryList"></tbody>
</table>


<!-- Loader -->
<div id="loader" class="loader" style="display: none;"></div>


<!-- Firebase + App Script -->
<script type="module">
 import {
   getAuth,
   onAuthStateChanged,
   signInWithEmailAndPassword,
   signOut
 } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
 import {
   initializeApp
 } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
 import {
   getFirestore,
   collection,
   getDocs,
   addDoc,
   updateDoc,
   deleteDoc,
   doc,
   serverTimestamp
 } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


 const firebaseConfig = {
   apiKey: "AIzaSyBGjt0PnRsG7lRv4PWfpECAaxdJpfCsoAM",
   authDomain: "casw-inventory-e2468.firebaseapp.com",
   projectId: "casw-inventory-e2468",
   storageBucket: "casw-inventory-e2468.appspot.com",
   messagingSenderId: "614257871007",
   appId: "1:614257871007:web:860ef30566c93af173baaa"
 };


 const app = initializeApp(firebaseConfig);
 const db = getFirestore(app);
 const inventoryRef = collection(db, "inventory");
 const auth = getAuth(app);


 onAuthStateChanged(auth, user => {
   const authSection = document.getElementById('authSection');
   const inventoryForm = document.getElementById('inventoryForm');
   const logoutBtn = document.getElementById('logoutBtn');
   const topBar = document.querySelector('.top-bar');
   const table = document.querySelector('table');


   if (user) {
     authSection.style.display = 'none';
     inventoryForm.style.display = 'block';
     logoutBtn.style.display = 'inline-block';
     topBar.style.display = 'flex';
     table.style.display = 'table';
     loadData();
   } else {
     authSection.style.display = 'block';
     inventoryForm.style.display = 'none';
     logoutBtn.style.display = 'none';
     topBar.style.display = 'none';
     table.style.display = 'none';
   }
 });


 document.getElementById('loginBtn').addEventListener('click', async e => {
   e.preventDefault();
   const email = document.getElementById('email').value;
   const password = document.getElementById('password').value;
   try {
     await signInWithEmailAndPassword(auth, email, password);
   } catch (error) {
     alert("Login failed: " + error.message);
   }
 });


 document.getElementById('logoutBtn').addEventListener('click', async () => {
   await signOut(auth);
 });


 let editingId = null;
 document.getElementById('inventoryForm').addEventListener('submit', async function (event) {
   event.preventDefault();


   const item = {
     serialNumber: document.getElementById('serialNumber').value.trim(),
     itemName: document.getElementById('itemName').value.trim(),
     category: document.getElementById('category').value.trim(),
     status: document.getElementById('status').value,
     site: document.getElementById('site').value
   };


   const fileInput = document.getElementById('photo');
   const file = fileInput.files[0];


   const finishSubmit = async (photoBase64 = "") => {
     const dataToSave = {
       ...item,
       photoURL: photoBase64,
       timestamp: serverTimestamp()
     };


     if (editingId) {
       await updateDoc(doc(db, "inventory", editingId), dataToSave);
       editingId = null;
     } else {
       const querySnapshot = await getDocs(inventoryRef);
       const exists = querySnapshot.docs.some(docSnap =>
         docSnap.data().serialNumber === item.serialNumber
       );


       if (exists) {
         alert("❗An item with this serial number already exists.");
         return;
       }


       await addDoc(inventoryRef, dataToSave);
     }


     document.getElementById('inventoryForm').reset();
     await loadData();
   };


   if (file) {
     const reader = new FileReader();
     reader.onloadend = () => finishSubmit(reader.result);
     reader.readAsDataURL(file);
   } else {
     finishSubmit();
   }
 });


 let chart; // Global variable to hold the chart instance

    async function loadData() {
      document.getElementById('loader').style.display = 'block';

      const querySnapshot = await getDocs(inventoryRef);
      const table = document.getElementById('inventoryList');
      table.innerHTML = "";
      const items = [];
      querySnapshot.forEach(docSnap => {
        items.push({ id: docSnap.id, ...docSnap.data() });
      });

      const total = items.length;
      const available = items.filter(item => item.status === 'Available').length;
      const inUse = items.filter(item => item.status === 'In Use').length;
      document.getElementById('summary').innerText = `Total Items: ${total} | Available: ${available} | In Use: ${inUse}`;
      // Save chart data for chart modal to use
      window.chartData = {
        labels: ['Available', 'In Use'],
        counts: [available, inUse]
      };

      // Render rows
      items.forEach(item => {
        const row = table.insertRow();
        row.innerHTML = `
          <td>${item.serialNumber}</td>
          <td>${item.itemName}</td>
          <td>${item.category}</td>
          <td>${item.status}</td>
          <td>${item.site}</td>
          <td>${item.timestamp?.toDate ? item.timestamp.toDate().toLocaleString() : "—"}</td>
          <td>${item.photoURL ? `<img src="${item.photoURL}" style="max-height: 40px; border-radius: 4px; cursor: pointer;">` : "—"}</td>
          <td>
            <button class='edit-btn' data-id="${item.id}" data-serial="${item.serialNumber}" data-name="${item.itemName}" data-category="${item.category}" data-status="${item.status}" data-site="${item.site}">Edit</button>
            <button class='remove-btn' onclick="removeItem('${item.id}')">Remove</button>
          </td>
        `;
      });

      // Draw or update chart
      const ctx = document.getElementById('summaryChart').getContext('2d');
      const data = {
        labels: ['Available', 'In Use'],
        datasets: [{
          label: 'Item Count by Status',
          data: [available, inUse],
          backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
          borderWidth: 1
        }]
      };

      if (chart) {
        chart.data = data;
        chart.update();
      } else {
        chart = new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                precision: 0
              }
            }
          }
        });
      }

      document.getElementById('loader').style.display = 'none';
    }



 window.removeItem = async function (id) {
   if (confirm("Are you sure you want to delete this item?")) {
     await deleteDoc(doc(db, "inventory", id));
     loadData();
   }
 };


 window.searchItems = function () {
   const filter = document.getElementById('searchBox').value.toLowerCase();
   const rows = document.getElementById('inventoryList').getElementsByTagName('tr');
   for (let row of rows) {
     row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
   }
 };


 window.sortTable = async function (columnIndex) {
   const querySnapshot = await getDocs(inventoryRef);
   const items = [];
   querySnapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));


   const keys = ["serialNumber", "itemName", "category", "status", "site", "timestamp"];
   items.sort((a, b) => {
     const key = keys[columnIndex];
     if (key === "timestamp") {
       const aTime = a.timestamp?.toDate?.() ?? new Date(0);
       const bTime = b.timestamp?.toDate?.() ?? new Date(0);
       return bTime - aTime;
     } else {
       return (a[key] || "").localeCompare(b[key] || "");
     }
   });


   const table = document.getElementById('inventoryList');
   table.innerHTML = "";
   items.forEach(item => {
     const row = table.insertRow();
     row.innerHTML = `
       <td>${item.serialNumber}</td>
       <td>${item.itemName}</td>
       <td>${item.category}</td>
       <td>${item.status}</td>
       <td>${item.site}</td>
       <td>${item.timestamp?.toDate ? item.timestamp.toDate().toLocaleString() : "—"}</td>
       <td>${item.photoURL ? `<img src="${item.photoURL}" style="max-height: 40px; border-radius: 4px; cursor: pointer;">` : "—"}</td>
       <td>
         <button class='edit-btn' data-id="${item.id}" data-serial="${item.serialNumber}" data-name="${item.itemName}" data-category="${item.category}" data-status="${item.status}" data-site="${item.site}">Edit</button>
         <button class='remove-btn' onclick="removeItem('${item.id}')">Remove</button>
       </td>
     `;
   });
 };


 // ✅ Modal functionality (no close button, click background to close)
 document.addEventListener("click", function (e) {
   if (e.target.tagName === "IMG" && e.target.src.startsWith("data:image")) {
     const modal = document.getElementById("imageModal");
     const modalImg = document.getElementById("modalImage");
     
     modalImg.src = e.target.src;
     modal.classList.add("show");
   }
 });

 // 🎯 Chart Modal functionality
document.getElementById("chartBtn").style.display = 'inline-block';
document.getElementById("chartBtn").addEventListener("click", function () {
  const modal = document.getElementById("chartModal");
  const ctx = document.getElementById("summaryChart").getContext("2d");

  if (chart) chart.destroy(); // prevent duplicate charts

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: window.chartData.labels,
      datasets: [{
        label: 'Item Count by Status',
        data: window.chartData.counts,
        backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          precision: 0
        }
      }
    }
  });

  modal.classList.add("show");
});

// Close chart modal on background click
document.getElementById("chartModal").addEventListener("click", function (e) {
  if (e.target.id === "chartModal") {
    this.classList.remove("show");
  }
});



 document.getElementById("imageModal").addEventListener("click", function (e) {
   if (e.target.id === "imageModal") {
     this.classList.remove("show");
   }
 });


 loadData(); // initial call
</script>
</body>
</html>



