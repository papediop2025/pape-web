<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CASW Inventory Tracker</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> <!-- 👈 Add PapaParse -->
</head>
<body>

  <!-- 🔓 Logout button -->
  <button id="logoutBtn" style="display: none;" class="logout-btn">Logout</button>

  <img src="CASW.png" alt="C.A.S.W Logo" class="auth-logo" />

  <!-- 🔐 Login -->
  <div id="authSection" class="auth-container">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <!-- ✅ Inventory Form -->
  <form id="inventoryForm" style="display: none;">
    <div class="form-fields">
      <input type="text" id="serialNumber" placeholder="Serial Number" required>
      <input type="text" id="itemName" placeholder="Item Name" required>
      <input type="text" id="category" placeholder="Category" required>
      <select id="status">
        <option value="Available">Available</option>
        <option value="In Use">In Use</option>
      </select>
      <select id="site">
        <option value="PS 18">PS 18</option>
        <option value="Bronx River">Bronx River</option>
        <option value="Beacon">Beacon</option>
        <option value="Main Office">Main Office</option>
      </select>
      <button type="submit">Add Item</button>
    </div>
  </form>

  <!-- ✅ Search + Export + Import -->
  <div class="top-bar" style="display: none; justify-content: space-between; align-items: center; margin: 10px 0;">
    <input type="text" id="searchBox" placeholder="Search..." onkeyup="searchItems()">
    <div id="summary" style="font-weight: bold;"></div>
    <div>
      <input type="file" id="importFile" accept=".csv">
      <button id="importBtn" type="button">Import CSV</button>
      <button id="exportBtn" type="button">Export CSV</button>
    </div>
  </div>

  <table id="inventoryTable" style="display: none;">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Serial Number</th>
        <th onclick="sortTable(1)">Name</th>
        <th onclick="sortTable(2)">Category</th>
        <th onclick="sortTable(3)">Status</th>
        <th onclick="sortTable(4)">Site</th>
        <th onclick="sortTable(5)">Last Updated</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="inventoryList"></tbody>
  </table>

  <!-- Firebase + Firestore -->
  <script type="module">
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGjt0PnRsG7lRv4PWfpECAaxdJpfCsoAM",
      authDomain: "casw-inventory-e2468.firebaseapp.com",
      projectId: "casw-inventory-e2468",
      storageBucket: "casw-inventory-e2468.firebasestorage.app",
      messagingSenderId: "614257871007",
      appId: "1:614257871007:web:860ef30566c93af173baaa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const inventoryRef = collection(db, "inventory");
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('inventoryForm').style.display = 'block';
        document.querySelector('table').style.display = 'table';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.querySelector('.top-bar').style.display = 'flex';
        loadData();
      } else {
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('inventoryForm').style.display = 'none';
        document.querySelector('table').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        document.querySelector('.top-bar').style.display = 'none';
      }
    });

    document.getElementById('loginBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
    });

    let editingId = null;
    document.getElementById('inventoryForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      const item = {
        serialNumber: document.getElementById('serialNumber').value.trim(),
        itemName: document.getElementById('itemName').value.trim(),
        category: document.getElementById('category').value.trim(),
        status: document.getElementById('status').value,
        site: document.getElementById('site').value
      };

      if (!item.serialNumber || !item.itemName || !item.category) {
        alert("Please fill all required fields.");
        return;
      }

      if (editingId) {
        await updateDoc(doc(db, "inventory", editingId), {
          ...item,
          timestamp: serverTimestamp()
        });

        editingId = null;
      } else {
        const querySnapshot = await getDocs(inventoryRef);
        const exists = querySnapshot.docs.some(docSnap =>
          docSnap.data().serialNumber === item.serialNumber
        );

        if (exists) {
          alert("❗An item with this serial number already exists.");
          return;
        }

        await addDoc(inventoryRef, {
          ...item,
          timestamp: serverTimestamp()
        });

      }


      document.getElementById('inventoryForm').reset();
      setTimeout(() => loadData(), 100);
    });

    function renderSummary(items) {
      const total = items.length;
      const available = items.filter(item => item.status === 'Available').length;
      const inUse = items.filter(item => item.status === 'In Use').length;
      document.getElementById('summary').innerText = `Total Items: ${total} | Available: ${available} | In Use: ${inUse}`;

      // Export CSV
      document.getElementById('exportBtn').addEventListener('click', () => {
        const rows = document.querySelectorAll('#inventoryList tr');
        const csvRows = [["Serial Number", "Item Name", "Category", "Status", "Site", "Last Updated"]];

        rows.forEach(row => {
          if (row.style.display === 'none') return;
          const cells = row.querySelectorAll('td');
          const rowData = [];
          for (let i = 0; i < 6; i++) {
            rowData.push(`"${cells[i].textContent.trim()}"`);
          }
          csvRows.push(rowData);
        });

        const blob = new Blob([csvRows.map(row => row.join(',')).join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'filtered_inventory.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    async function loadData() {
        document.getElementById('loader').style.display = 'block';
        
        const querySnapshot = await getDocs(inventoryRef);
        const table = document.getElementById('inventoryList');
        table.innerHTML = "";
        const items = [];
        querySnapshot.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderSummary(items);
        items.forEach(item => {
          const row = table.insertRow();
          row.innerHTML = `
            <td>${item.serialNumber}</td>
            <td>${item.itemName}</td>
            <td>${item.category}</td>
            <td>${item.status}</td>
            <td>${item.site}</td>
            <td>${item.timestamp?.toDate ? item.timestamp.toDate().toLocaleString() : "—"}</td>
            <td>
              <button class='edit-btn' data-id="${item.id}" data-serial="${item.serialNumber}" data-name="${item.itemName}" data-category="${item.category}" data-status="${item.status}" data-site="${item.site}">Edit</button>
              <button class='remove-btn' onclick="removeItem('${item.id}')">Remove</button>
            </td>
            `;
        });

  document.getElementById('loader').style.display = 'none';
}


    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('edit-btn')) {
        const btn = e.target;
        document.getElementById('serialNumber').value = btn.getAttribute('data-serial');
        document.getElementById('itemName').value = btn.getAttribute('data-name');
        document.getElementById('category').value = btn.getAttribute('data-category');
        document.getElementById('status').value = btn.getAttribute('data-status');
        document.getElementById('site').value = btn.getAttribute('data-site');
        editingId = btn.getAttribute('data-id');
      }
    });

    window.removeItem = async function (id) {
      const confirmDelete = confirm("Are you sure you want to delete this item?");
      if (confirmDelete) {
        await deleteDoc(doc(db, "inventory", id));
        loadData();
      }
    };


    window.searchItems = function () {
      const filter = document.getElementById('searchBox').value.toLowerCase();
      const rows = document.getElementById('inventoryList').getElementsByTagName('tr');
      for (let row of rows) {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
      }
    };

    window.sortTable = async function (columnIndex) {
      const querySnapshot = await getDocs(inventoryRef);
      const items = [];
      querySnapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
      const keys = ["serialNumber", "itemName", "category", "status", "site", "timestamp"];
      items.sort((a, b) => {
        const key = keys[columnIndex];
        if (key === "timestamp") {
          const aTime = a.timestamp?.toDate?.() ?? new Date(0);
          const bTime = b.timestamp?.toDate?.() ?? new Date(0);
          return bTime - aTime; // Descending: newest first
        } else {
          return (a[key] || "").localeCompare(b[key] || "");
        }
      });

      const table = document.getElementById('inventoryList');
      table.innerHTML = "";
      items.forEach(item => {
        const row = table.insertRow();
        row.innerHTML = `
          <td>${item.serialNumber}</td>
          <td>${item.itemName}</td>
          <td>${item.category}</td>
          <td>${item.status}</td>
          <td>${item.site}</td>
          <td>${item.timestamp?.toDate ? item.timestamp.toDate().toLocaleString() : "—"}</td>
          <td>
            <button class='edit-btn' data-id="${item.id}" data-serial="${item.serialNumber}" data-name="${item.itemName}" data-category="${item.category}" data-status="${item.status}" data-site="${item.site}">Edit</button>
            <button class='remove-btn' onclick="removeItem('${item.id}')">Remove</button>
          </td>
          `;
      });
    };

    // ✅ IMPORT CSV using PapaParse
    document.getElementById('importBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select a CSV file first.");
        return;
      }

      document.getElementById('loader').style.display = 'block';

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          const data = results.data;
          let addedCount = 0;
          let skippedCount = 0;

          for (let i = 0; i < data.length; i += 20) {
            const chunk = data.slice(i, i + 20);
            await Promise.all(
              chunk.map(async (row) => {
                const item = {
                  serialNumber: row["Serial Number"]?.trim() || "",
                  itemName: row["Item Name"]?.trim() || "",
                  category: row["Category"]?.trim() || "",
                  status: row["Status"]?.trim() || "Available",
                  site: row["Site"]?.trim() || "Main Office"
                };
                if (item.serialNumber && item.itemName && item.category) {
                  await addDoc(inventoryRef, item);
                  addedCount++;
                } else {
                  skippedCount++;
                  console.warn("⛔ Skipping invalid row:", row);
                }
              })
            );
          }

          alert(`✅ Import complete!\nAdded: ${addedCount}\nSkipped: ${skippedCount}`);
          document.getElementById('loader').style.display = 'none';
          loadData();
        }
      });
    });


    loadData(); // Initial load
  </script>
<div id="loader" class="loader" style="display: none;"></div>

</body>
</html>
